# üîê psql-container-ssl-connection-setup

A small development/demo setup to run PostgreSQL with TLS/SSL enabled inside Docker Compose.

---

## üìñ Overview
This folder contains a Compose-based Postgres setup that demonstrates how to configure Postgres to use server TLS certificates (SAN-capable certs generated by the `create_self_signed_cert` tool in this repo). It's intended for local development and examples (not production secrets management).

---

## üìÇ What‚Äôs inside
- `.env.example` ‚Äî Example environment variables.
- `.env` ‚Äî (local) environment values used by `docker compose` (keep out of VCS).
- `docker-compose.yml` ‚Äî Compose file to run the `db` service.
- `Dockerfile` ‚Äî Optional image customization (copies configs / optional cert baking).
- `certs/` ‚Äî (optional) host cert directory you can mount (contains your server.crt / server.key / ca.crt).
- `example_certs/` ‚Äî example/demo certs included for convenience.
- `postgres/postgresql.conf` ‚Äî Postgres configuration (sets ssl = on and cert paths).
- `postgres/pg_hba.conf` ‚Äî Authentication rules (contains hostssl / hostnossl rules).
- `scripts/` ‚Äî helpers: `start_psql.sh`, `create_db_if_not_exists.sh`, `down_clean.sh`.

---

## ‚úÖ Quick start (recommended)
1. Copy `.env.example` to `.env` and set a secure `POSTGRES_PASSWORD`:

```bash
cp .env.example .env
# edit .env and set POSTGRES_PASSWORD
```

2. Confirm certs are available in the host path referenced by `CERTS_DIR` in `.env` (or copy `example_certs` to that location).

3. Build and run:

```bash
# build (if Dockerfile is used or you changed the image)
docker compose build

# start
docker compose up -d
```

4. Check logs and confirm no SSL errors:

```bash
docker compose logs -f db
```

---

## üîß Certificate path options (pick one)
There are three common ways to provide server certificates to the container. Choose one and make sure `postgresql.conf` and `docker-compose.yml` paths match.

Option A ‚Äî mount to `/certs` (minimal change)
- Keep `postgresql.conf` pointing to `/certs/server.crt` & `/certs/server.key`.
- Compose mounts host cert dir to `/certs:ro`.

Option B ‚Äî mount to `/var/lib/postgresql/tls` (matches current config)
- Use the repo default config which sets cert files to `/var/lib/postgresql/tls/...`.
- Mount the host cert dir to `/var/lib/postgresql/tls:ro` in `docker-compose.yml`.

Option C ‚Äî bake certs into image (dev/demo only)
- COPY certs into image via `Dockerfile` and set proper owner/mode.
- Good for portable examples, **not** for secrets in VCS.

---

## üß™ How to verify SSL/TLS is active
1. Inside container:

```bash
docker compose exec db bash
psql -U "$POSTGRES_USER" -c "SHOW ssl;"    # should print 'on'
psql -U "$POSTGRES_USER" -c "SHOW ssl_cert_file;"  # path to cert used
```

2. Connect from host requiring TLS:

```bash
export PGPASSWORD=yourpassword
psql "host=localhost port=${PG_PORT:-5432} dbname=postgres user=$POSTGRES_USER sslmode=require"
```

3. Confirm non-SSL connections are rejected (if `pg_hba.conf` contains `hostnossl ... reject`):

```bash
psql "host=localhost port=${PG_PORT:-5432} dbname=postgres user=$POSTGRES_USER sslmode=disable"
# should fail when non-SSL is rejected
```

---

## ‚ùó Troubleshooting
- WARN: `The "POSTGRES_PASSWORD" variable is not set` ‚Äî create `.env` or export `POSTGRES_PASSWORD`.
- Path mismatch ‚Äî make sure `postgresql.conf` paths match your Compose volume mount location.
- Permissions: private key must be readable only by Postgres (owner `postgres`, mode `600`). If mounting from macOS, UID/GID mapping can be an issue; consider copying in via Dockerfile for local dev.
- Check `docker compose logs db` for SSL load errors (e.g. "could not load private key").

---

## üîí Security notes
- Do NOT commit private keys or real `.env` containing passwords.
- Use `ssl_ca_file` + `pg_hba.conf` cert authentication if you want to verify client certs.

---

## üßæ Useful commands
- Start: `docker compose up -d`
- Stop & remove: `./scripts/down_clean.sh`
- Init DB (example): `./scripts/create_db_if_not_exists.sh`
- Start helper: `./scripts/start_psql.sh`

---

## ‚úçÔ∏è Suggested commit message
`docs: add README for psql-container-ssl-connection-setup (usage, build, SSL tests)`

---

If you'd like, I can also:
- Adjust the README wording to Thai, or
- Apply the recommended path/permission fixes automatically and run a verification test locally (if you want me to commit changes).

---

*Generated by GitHub Copilot (Raptor mini ‚Äî Preview).*